# Bitaxe Persistent Logging (BPL)

Since Bitaxes don't keep track of operational stats by themselves, and the AxeOS webpage _temporarily_ shows _some_ stats _only while you are on it_, I decided to make a more _persistent_ solution for logging _all_ of your Bitaxe's stats in a effortless and easy to read way that doesn't require your presence.

BPL is a simple Node.js Express server that:

- Queries your Bitaxe for stats every 5 seconds via 'GET /api/system/info'
- Logs key details to a .csv file
- Sends a single PNG snapshot containing every stat graphed since boot when the Express server endpoint is accessed

<details>

<summary><u>Click here to see some examples:</u></summary>

- Typical operation:
  ![An example snapshot generated by BPL](/.github/resources/README/typical.png)

- Hitting a new best difficulty:
  ![An example snapshot generated by BPL](/.github/resources/README/best.png)

- New best + catching power fluctuation (2TH/s? Nah. 150TH for 1s):
  ![An example snapshot generated by BPL](/.github/resources/README/surge.png)

</details>

## Table of Contents

- [Features](#features)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Usage](#usage)
- [Configuration](#configuration)
- [Multi-Bitaxe Monitoring](#multi-bitaxe-monitoring)
- [Data Logging Retention](#data-logging-retention)
- [License](#license)

## Features

- All stats since boot are logged every 5 seconds, regardless if you are interacting with your Bitaxe or not
- When you wish to see how your Bitaxe has been performing, you just access this server and it will return a snapshot of various graphed stats
- It's as simple as running `node app.js` and letting it do its work. No manual intervention needed besides starting/stopping the server.

## Prerequisites

### Recommended Hardware

- Raspberry Pi Zero 2 W
  - Very low power usage for standalone 24/7 logging
- Or Raspberry Pi 4b or newer
  - Easily handles self-hosted Bitcoin Core + Electrs + Mempool + Lightning + Public Pool + BPL while still being low power

### Recommended OS

- Raspberry Pi OS Lite
- Or any Debian-based Linux distro

### Packages

- Node.js + npm - to run the server and install server package dependencies
- jq - to parse JSON objects
- gnuplot - to plot the .csv data points
- montage - to combine all graphs into one image
- screen - to run the server detached from terminals

```bash
sudo apt install npm jq gnuplot montage screen
```

## Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/Katyatu/BitaxePersistentLogging.git
   cd BitaxePersistentLogging
   ```
2. Install dependencies:
   ```bash
   npm install
   ```
3. Create a `config.json` file in the project root (see [Configuration](#configuration)):
   ```bash
   cp config.example.json config.json
   nano config.json
   ```

## Usage

1. Starting the server: `screen -S BPL node app.js` to start, then `CTRL+A, D` to detach
2. Accessing the server: `http://<serverLocalIP>:<serverPort>` (defined in `config.json`).
3. Stopping the server: `screen -r BPL` to reattach, and `CTRL+C` to gracefully stop

Note: Make sure your working directory is in the project root, and wait at least 10 seconds after starting the server before requesting a snapshot.

## Configuration

The server reads settings from `config.json` in the project root. Example:

```json
{
  "serverLocalIP": "192.168.x.xxx",
  "serverPort": "333x",
  "bitaxeLocalIP": "192.168.x.xxx",
  "bitaxeName": "Gamma-x"
}
```

- Copy `config.example.json` to `config.json` and update values as needed.

## Multi-Bitaxe Monitoring

If you have more than one Bitaxe you want to monitor with BPL, you will need to do the following:

1. Each Bitaxe needs its own BPL instance. Meaning, for each Bitaxe, you will need to clone this repo, rename the project root from "BitaxePersistentLogging" to a unique name, and configure it properly as described below. Once you finish setting up one instance, you can repeat the process for as many Bitaxes you have.
2. If running multiple instances on the same machine, make sure you...
   - Set the "serverPort" to a port that isn't already in use by another BPL instance
   - Keep "serverLocalIP" the same, since it's on the same machine
   - Set the "bitaxeLocalIP" to the Bitaxe local IP you want to monitor
   - Set a unique "bitaxeName" to keep instance data logging from merging with each other
3. If using the `screen -S BPL node app.js` command, change "BPL" to a unique name. ie. `screen -S BPL-1 node app.js` `screen -S BPL-2 node app.js` etc.

## Data Logging Retention

BPL logging and snapshots are temporarily stored at `/tmp/BPL/`, are overwritten at BPL start, and do not survive system reboots. The scope of persistence only spans from the point of Bitaxe boot to the time you stop BPL and reboot/shutdown your machine. BPL is only designed for monitoring the current boot cycle, not long-term monitoring of multiple boot cycles. If you wish to keep any logged data after stopping BPL, copy/move the .csv files out of memory and into storage before rebooting/shutting down your machine.

## License

See [LICENSE](LICENSE) for details.
